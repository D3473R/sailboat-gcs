<template>
  <div>
    <div class="grid-container">
      <div class="select">
        <v-select
          v-if="mapMode === 'edit'"
          class="select-comPorts"
          ref="selectComPorts"
          clearable
          @click:clear="handleSelectCloseClick"
          :items="comPorts"
          item-text="comName"
          item-value="comName"
          label="Port"
          v-on:change="handleComPortChange"
        ></v-select>
        <div v-else></div>

        <v-dialog v-model="dialog" v-if="mapMode === 'edit'">
          <template v-slot:activator="{ on }">
            <v-btn color="primary" dark v-on="on">Open waypoint replay</v-btn>
          </template>
          <v-card>
            <v-card-title class="headline">Paste waypoints</v-card-title>
            <v-card-actions>
              <v-spacer></v-spacer>
              <v-btn color="success" text @click="openWaypointReplay">Load replay</v-btn>
            </v-card-actions>
            <v-card-text>
              <v-textarea outlined autofocus clearable v-model="waypointText" auto-grow></v-textarea>
              <span class="warning--text">Warning: All current waypoints will get deleted!</span>
            </v-card-text>
          </v-card>
        </v-dialog>
        <v-btn color="primary" dark v-else @click="closeWaypointReplay">Close waypoint replay</v-btn>
      </div>

      <v-indicators class="indicators" />
      <v-leaflet
        class="map"
        ref="leaflet"
        :mapMode="mapMode"
        v-on:upload-waypoints="uploadWaypoints"
      />
    </div>
    <v-snackbar v-model="snackbar['enabled']" :color="snackbar['color']">{{ snackbar['message'] }}</v-snackbar>
  </div>
</template>

<script lang="ts">
import Vue from "vue";
import { Component } from "vue-property-decorator";
import { MAVLinkModule, MAVLinkMessage } from "@ifrunistuttgart/node-mavlink";
import Serialport, { PortInfo } from "serialport";
import { messageRegistry } from "../assets/mavlink/message-registry";
import { Heading, Attitude } from "vue-flight-indicators";
import { Heartbeat } from "@/assets/mavlink/messages/heartbeat";
import { RadioStatus } from "@/assets/mavlink/messages/radio-status";
import { BoatStatus } from "@/assets/mavlink/messages/boat-status";
import { MissionRequestInt } from "@/assets/mavlink/messages/mission-request-int";
import Leaflet from "./Leaflet.vue";
import Indicators from "./Indicators.vue";
import { Modes } from "../models/modes";
import { parse } from "papaparse";
import { ReplayWaypoint } from "../models/replayWaypoint";
import { MissionCount } from "../assets/mavlink/messages/mission-count";
import { MissionItemInt } from "../assets/mavlink/messages/mission-item-int";

Vue.component("v-heading", Heading);
Vue.component("v-attitude", Attitude);
Vue.component("v-leaflet", Leaflet);
Vue.component("v-indicators", Indicators);

// Converts from degrees to radians.
const radians = function(degrees: number) {
  return (degrees * Math.PI) / 180;
};

// Converts from radians to degrees.
const degrees = function(radians: number) {
  return (radians * 180) / Math.PI;
};

@Component
export default class SailboatGcs extends Vue {
  mavLink?: MAVLinkModule;
  serialPort?: Serialport;
  connectionOpen: boolean = false;

  dialog = false;
  waypointText = `2019-05-24T10:43:13.304711,60.1048155,19.946052
2019-05-24T10:43:14.298569,60.10481383333333,19.946051
2019-05-24T10:43:15.309855,60.104812333333335,19.94605
2019-05-24T10:43:16.301961,60.104810666666665,19.946048666666666
2019-05-24T10:43:17.304672,60.104808166666665,19.946048
2019-05-24T10:43:18.320703,60.104806333333336,19.946047
2019-05-24T10:43:19.298233,60.104805166666665,19.946046166666665
2019-05-24T10:43:20.293352,60.10480416666667,19.946044
2019-05-24T10:43:21.307568,60.10480283333333,19.946043
2019-05-24T10:43:22.314926,60.10480166666667,19.9460425
2019-05-24T10:43:23.316156,60.104800833333336,19.946040833333335
2019-05-24T10:43:24.336279,60.104798833333334,19.946042333333335
2019-05-24T10:43:25.321509,60.10479633333333,19.946043666666668
2019-05-24T10:43:26.311517,60.104796,19.946043500000002
2019-05-24T10:43:27.312852,60.104795,19.946045166666668
2019-05-24T10:43:28.314194,60.1047945,19.946045833333333
2019-05-24T10:43:29.310482,60.10479466666666,19.946045666666667
2019-05-24T10:43:30.311888,60.10479466666666,19.9460455
2019-05-24T10:43:31.310700,60.104794166666665,19.946046833333334
2019-05-24T10:43:32.315842,60.10479316666667,19.946047333333333
2019-05-24T10:43:33.292146,60.104793,19.946045666666667
2019-05-24T10:43:34.303576,60.104792333333336,19.946045333333334
2019-05-24T10:43:35.302408,60.10479216666667,19.946044166666667
2019-05-24T10:43:36.302448,60.104793,19.946045
2019-05-24T10:43:37.306332,60.1047925,19.946045166666668
2019-05-24T10:43:38.311323,60.10479216666667,19.946044833333332
2019-05-24T10:43:39.286322,60.10479266666667,19.946043500000002
2019-05-24T10:43:40.302655,60.104792833333335,19.946043
2019-05-24T10:43:41.307796,60.10479383333333,19.94604216666667
2019-05-24T10:43:42.313005,60.10479383333333,19.946041
2019-05-24T10:43:43.320671,60.10479383333333,19.946040666666665
2019-05-24T10:43:44.293572,60.104794,19.946040666666665
2019-05-24T10:43:45.310369,60.10479383333333,19.94604
2019-05-24T10:43:46.301678,60.1047945,19.9460395
2019-05-24T10:43:47.296838,60.104795333333335,19.946038833333333
2019-05-24T10:43:48.310998,60.10479516666667,19.946037333333333
2019-05-24T10:43:49.300765,60.104795,19.946035666666667
2019-05-24T10:43:50.299514,60.10479566666667,19.946034666666666
2019-05-24T10:43:51.307807,60.10479616666667,19.946034166666667
2019-05-24T10:43:52.305031,60.104795833333334,19.946033166666666
2019-05-24T10:43:53.304981,60.10479683333333,19.946033166666666
2019-05-24T10:43:54.311808,60.104797166666664,19.946033
2019-05-24T10:43:55.301906,60.10479866666667,19.9460335
2019-05-24T10:43:56.312730,60.10479983333333,19.9460345
2019-05-24T10:43:57.290240,60.104799666666665,19.9460345
2019-05-24T10:43:58.310448,60.10479983333333,19.9460355
2019-05-24T10:43:59.303023,60.10479983333333,19.946036333333332
2019-05-24T10:44:00.321448,60.10480116666667,19.946037666666665
2019-05-24T10:44:01.291594,60.10480333333334,19.9460385
2019-05-24T10:44:02.304340,60.10480483333333,19.94604
2019-05-24T10:44:03.298755,60.104806,19.946041166666667
2019-05-24T10:44:04.304022,60.104806333333336,19.946042666666667
2019-05-24T10:44:05.313281,60.10480716666667,19.946043500000002
2019-05-24T10:44:06.314868,60.104809,19.946043500000002
2019-05-24T10:44:07.342745,60.104809833333334,19.9460445
2019-05-24T10:44:08.315153,60.104809833333334,19.946045333333334
2019-05-24T10:44:09.308840,60.1048105,19.946046333333335
2019-05-24T10:44:10.301548,60.10481166666667,19.9460455
2019-05-24T10:44:11.307008,60.104811833333336,19.9460475
2019-05-24T10:44:12.316218,60.10481166666667,19.9460475
2019-05-24T10:44:13.316686,60.104812,19.946047166666666
2019-05-24T10:44:14.291887,60.104812,19.946047833333335
2019-05-24T10:44:15.316840,60.104812,19.946050166666666
2019-05-24T10:44:16.310915,60.10481216666667,19.946054333333333
2019-05-24T10:44:17.299344,60.10481133333333,19.946059666666667
2019-05-24T10:44:18.291650,60.104811166666664,19.946067
2019-05-24T10:44:19.304266,60.104811833333336,19.946078166666666
2019-05-24T10:44:20.304573,60.1048125,19.946092333333333
2019-05-24T10:44:21.284538,60.104814166666664,19.946109166666666
2019-05-24T10:44:22.303198,60.10481716666666,19.9461265
2019-05-24T10:44:23.297241,60.104820833333335,19.946144333333333
2019-05-24T10:44:24.316094,60.10482533333333,19.946164666666668
2019-05-24T10:44:25.306289,60.10482916666667,19.946188166666666
2019-05-24T10:44:26.311265,60.104830666666665,19.9462175
2019-05-24T10:44:27.345139,60.10483116666666,19.94625033333333
2019-05-24T10:44:28.304106,60.104831833333336,19.946283833333332
2019-05-24T10:44:29.306693,60.104833666666664,19.946318833333333
2019-05-24T10:44:30.332700,60.104835666666666,19.946356
2019-05-24T10:44:31.315454,60.10483583333333,19.946394833333333
2019-05-24T10:44:32.318218,60.10483583333333,19.946434166666666
2019-05-24T10:44:33.302507,60.104835333333334,19.946475333333332
2019-05-24T10:44:34.304835,60.10483516666667,19.946517
2019-05-24T10:44:35.306271,60.104835,19.946558
2019-05-24T10:44:36.330161,60.1048325,19.946599666666668
2019-05-24T10:44:37.311621,60.10482866666667,19.946641833333334
2019-05-24T10:44:38.318985,60.104826,19.9466855
2019-05-24T10:44:39.324148,60.104823833333334,19.946728333333333
2019-05-24T10:44:40.333965,60.104820833333335,19.946773166666667
2019-05-24T10:44:41.328264,60.10481716666666,19.9468175
2019-05-24T10:44:42.327021,60.104814,19.946861166666668
2019-05-24T10:44:43.307968,60.1048115,19.946907666666668
2019-05-24T10:44:44.310086,60.104807666666666,19.946954
2019-05-24T10:44:45.312312,60.104802666666664,19.9469995
2019-05-24T10:44:46.313691,60.10479683333333,19.947043999999998
2019-05-24T10:44:47.335947,60.10479216666667,19.947089
2019-05-24T10:44:48.322641,60.10478833333333,19.947134333333334
2019-05-24T10:44:49.326682,60.10478466666667,19.947180833333334
2019-05-24T10:44:50.320835,60.1047805,19.947226833333332
2019-05-24T10:44:51.319814,60.104775833333335,19.947272
2019-05-24T10:44:52.339743,60.10477133333333,19.947318166666665
2019-05-24T10:44:53.322269,60.104767333333335,19.947367166666666
2019-05-24T10:44:54.308799,60.10476233333333,19.947415666666668
2019-05-24T10:44:55.308892,60.104755833333336,19.947464166666666
2019-05-24T10:44:56.329914,60.104748666666666,19.9475115
2019-05-24T10:44:57.328970,60.1047425,19.947560333333332
2019-05-24T10:44:58.321576,60.104736,19.947609166666666
2019-05-24T10:44:59.306678,60.10473116666667,19.947659833333333
2019-05-24T10:45:00.327328,60.1047245,19.9477085
2019-05-24T10:45:01.304577,60.1047185,19.947757
2019-05-24T10:45:02.309618,60.10471233333333,19.947803333333333
2019-05-24T10:45:03.330435,60.104707,19.947851
2019-05-24T10:45:04.310806,60.104704166666664,19.9478985
2019-05-24T10:45:05.326183,60.10469966666667,19.947945
2019-05-24T10:45:06.340271,60.10469366666667,19.9479955
2019-05-24T10:45:07.322519,60.10468866666667,19.9480475
2019-05-24T10:45:08.325213,60.10468483333333,19.948098666666667
2019-05-24T10:45:09.329246,60.104682333333336,19.94814866666667
2019-05-24T10:45:10.323761,60.1046795,19.948199333333335
2019-05-24T10:45:11.321375,60.104678,19.9482515
2019-05-24T10:45:12.321387,60.104677333333335,19.948301666666666
2019-05-24T10:45:13.307790,60.104677,19.94835
2019-05-24T10:45:14.314149,60.104674833333334,19.948396333333335
2019-05-24T10:45:15.311762,60.1046715,19.94844416666667
2019-05-24T10:45:16.311783,60.10467,19.948492833333333
2019-05-24T10:45:17.315646,60.104668,19.948541666666667
2019-05-24T10:45:18.336995,60.10466433333333,19.948589833333333
2019-05-24T10:45:19.323309,60.104659833333336,19.948638166666665
2019-05-24T10:45:20.323440,60.104656,19.94868616666667
2019-05-24T10:45:21.318598,60.104653166666665,19.9487325
2019-05-24T10:45:22.302402,60.10465083333333,19.948775
2019-05-24T10:45:23.303714,60.1046495,19.948811
2019-05-24T10:45:24.315136,60.10464866666667,19.948844166666667
2019-05-24T10:45:25.302656,60.10464783333333,19.9488735
2019-05-24T10:45:26.306600,60.10464866666667,19.948899166666667
2019-05-24T10:45:27.295375,60.104649333333334,19.948924333333334
2019-05-24T10:45:28.320341,60.1046505,19.94895066666667
2019-05-24T10:45:29.295564,60.104651833333335,19.948974833333335
2019-05-24T10:45:30.308422,60.104653,19.948995166666666
2019-05-24T10:45:31.311016,60.10465533333333,19.949014333333334
2019-05-24T10:45:32.301106,60.104657,19.949031166666668
2019-05-24T10:45:33.287504,60.10465883333333,19.9490475
2019-05-24T10:45:34.290085,60.1046615,19.949063
2019-05-24T10:45:35.291478,60.104664666666665,19.949077666666668
2019-05-24T10:45:36.314026,60.10466733333333,19.949091833333334
2019-05-24T10:45:37.315377,60.1046705,19.949102833333335
2019-05-24T10:45:38.329219,60.10467416666667,19.949114333333334
2019-05-24T10:45:39.318093,60.10468,19.9491255
2019-05-24T10:45:40.300697,60.104684,19.949137333333333
2019-05-24T10:45:41.299525,60.10468866666667,19.949148666666666
2019-05-24T10:45:42.313372,60.10469466666667,19.949159666666667
2019-05-24T10:45:43.304677,60.1047015,19.949169333333334
2019-05-24T10:45:44.306278,60.104704,19.949175666666665
2019-05-24T10:45:45.285154,60.1047085,19.949181333333332
2019-05-24T10:45:46.305195,60.10471483333333,19.949189333333333
2019-05-24T10:45:47.288470,60.10472166666667,19.9492065
2019-05-24T10:45:48.291745,60.104723,19.949225
2019-05-24T10:45:49.311867,60.104719333333335,19.9492335
2019-05-24T10:45:50.305618,60.10471866666666,19.9492385
2019-05-24T10:45:51.310041,60.104718,19.94924616666667
2019-05-24T10:45:52.307005,60.104718166666665,19.949253
2019-05-24T10:45:53.299570,60.10471883333334,19.949262833333332
2019-05-24T10:45:54.299550,60.10471716666667,19.9492755
2019-05-24T10:45:55.315139,60.10471533333333,19.94928833333333
2019-05-24T10:45:56.306708,60.1047125,19.9493005
2019-05-24T10:45:57.306931,60.10470816666667,19.949311
2019-05-24T10:45:58.283226,60.104705,19.949320333333333
2019-05-24T10:45:59.305556,60.104701166666665,19.94933066666667
2019-05-24T10:46:00.306202,60.104697333333334,19.949340833333334
2019-05-24T10:46:01.298647,60.10469416666667,19.949349833333333
2019-05-24T10:46:02.288772,60.1046905,19.949358666666665
2019-05-24T10:46:03.298813,60.10468733333333,19.949366666666666
2019-05-24T10:46:04.298963,60.104685333333336,19.949375166666666
2019-05-24T10:46:05.303510,60.1046825,19.949384833333333
2019-05-24T10:46:06.303094,60.10467916666666,19.949393166666667
2019-05-24T10:46:07.302820,60.104674833333334,19.949401333333334
2019-05-24T10:46:08.296004,60.10467216666667,19.94940666666667
2019-05-24T10:46:09.296960,60.1046715,19.9494105
2019-05-24T10:46:10.298298,60.104669,19.9494165
2019-05-24T10:46:11.321207,60.104667,19.949421666666666
2019-05-24T10:46:12.297683,60.104668,19.949423833333334
2019-05-24T10:46:13.304277,60.10466866666667,19.949423666666668
2019-05-24T10:46:14.288888,60.10467233333333,19.949423333333332
2019-05-24T10:46:15.297085,60.10467516666667,19.949424333333333
2019-05-24T10:46:16.295449,60.104677,19.949422
2019-05-24T10:46:17.289623,60.104679,19.949420833333335
2019-05-24T10:46:18.301171,60.104682,19.949421166666667
2019-05-24T10:46:19.300567,60.10468516666667,19.949422333333334
2019-05-24T10:46:20.288757,60.10468733333333,19.949422833333333
2019-05-24T10:46:21.300618,60.10469,19.949421333333333
2019-05-24T10:46:22.307737,60.104693,19.9494205
2019-05-24T10:46:23.292328,60.10469633333334,19.949419
2019-05-24T10:46:24.300456,60.104699,19.949413833333335
2019-05-24T10:46:25.327769,60.10470016666667,19.949406333333332
2019-05-24T10:46:26.330455,60.104698666666664,19.949397833333332
2019-05-24T10:46:27.321924,60.1046955,19.949393333333333
2019-05-24T10:46:28.329754,60.10469283333333,19.94938833333333
2019-05-24T10:46:29.305477,60.10469166666667,19.949381
2019-05-24T10:46:30.305620,60.104688833333334,19.9493775
2019-05-24T10:46:31.303283,60.104687,19.949370833333333
2019-05-24T10:46:32.303441,60.104687166666665,19.949365833333335
2019-05-24T10:46:33.308716,60.10468566666667,19.9493605
2019-05-24T10:46:34.293473,60.104684,19.949355833333332
2019-05-24T10:46:35.310954,60.10468266666667,19.949350666666668
2019-05-24T10:46:36.302402,60.104682,19.94934616666667
2019-05-24T10:46:37.312333,60.10468133333333,19.949343333333335
2019-05-24T10:46:38.319394,60.1046815,19.9493405
2019-05-24T10:46:39.298947,60.104683666666666,19.9493375
2019-05-24T10:46:40.289505,60.1046845,19.9493365
2019-05-24T10:46:41.289185,60.10468616666667,19.949335333333334
2019-05-24T10:46:42.293184,60.1046895,19.949333666666668
2019-05-24T10:46:43.289750,60.104691333333335,19.949334333333333
2019-05-24T10:46:44.291968,60.1046935,19.949331833333332
2019-05-24T10:46:45.291202,60.10469483333333,19.949329
2019-05-24T10:46:46.303084,60.10469783333333,19.9493275
2019-05-24T10:46:47.298782,60.1047005,19.949326666666668
2019-05-24T10:46:48.291093,60.10470316666667,19.9493235
2019-05-24T10:46:49.288016,60.1047055,19.949321333333334
2019-05-24T10:46:50.289088,60.104708333333335,19.949318666666667
2019-05-24T10:46:51.275601,60.10471016666666,19.949316
2019-05-24T10:46:52.313378,60.10471166666667,19.949310666666666
2019-05-24T10:46:53.316150,60.10471233333333,19.949303333333333
2019-05-24T10:46:54.310807,60.10471233333333,19.949298666666667
2019-05-24T10:46:55.302111,60.104712666666664,19.9492945
2019-05-24T10:46:56.318057,60.10471416666667,19.949293666666666
2019-05-24T10:46:57.304895,60.104716333333336,19.949291666666667
2019-05-24T10:46:58.302036,60.1047175,19.94929
2019-05-24T10:46:59.305093,60.10472016666667,19.949286166666667
2019-05-24T10:47:00.314684,60.10472016666667,19.9492845
2019-05-24T10:47:01.287439,60.104719333333335,19.9492815
2019-05-24T10:47:02.299561,60.10471883333334,19.949278333333332
2019-05-24T10:47:03.298040,60.10471833333333,19.949276666666666
2019-05-24T10:47:04.304450,60.1047185,19.949274833333334
2019-05-24T10:47:05.289490,60.10471966666667,19.949272333333333
2019-05-24T10:47:06.303107,60.10472166666667,19.949270833333333
2019-05-24T10:47:07.300888,60.10472383333333,19.949268833333335
2019-05-24T10:47:08.290960,60.104725333333334,19.949267666666668
2019-05-24T10:47:09.280854,60.104728333333334,19.949263833333333
2019-05-24T10:47:10.292011,60.10472983333333,19.949260166666665
2019-05-24T10:47:11.293886,60.1047295,19.949259666666666
2019-05-24T10:47:12.290959,60.104732,19.9492565
2019-05-24T10:47:13.282722,60.10473366666667,19.949255
2019-05-24T10:47:14.286143,60.104736333333335,19.949253
2019-05-24T10:47:15.293133,60.104738,19.949251666666665
2019-05-24T10:47:16.281492,60.10474033333333,19.949251333333333
2019-05-24T10:47:17.295065,60.104743166666665,19.9492445
2019-05-24T10:47:18.295461,60.10474283333333,19.9492375
2019-05-24T10:47:19.298066,60.104741833333335,19.9492305
2019-05-24T10:47:20.288581,60.10474,19.9492255
2019-05-24T10:47:21.301822,60.104739333333335,19.94922366666667
2019-05-24T10:47:22.307945,60.104738833333336,19.949221333333334
2019-05-24T10:47:23.300430,60.1047405,19.949218333333334
2019-05-24T10:47:24.305511,60.104741833333335,19.949217833333332
2019-05-24T10:47:25.287849,60.10474416666667,19.9492165
2019-05-24T10:47:26.313240,60.104746666666664,19.949215333333335
2019-05-24T10:47:27.289307,60.104749,19.949214333333334
2019-05-24T10:47:28.303269,60.104752,19.949212166666666
2019-05-24T10:47:29.295142,60.104754166666666,19.94920966666667
2019-05-24T10:47:32.412392,60.10476,19.949205
2019-05-24T10:47:32.560766,60.1047625,19.949203166666667
2019-05-24T10:47:33.280193,60.1047665,19.949199
2019-05-24T10:47:34.298401,60.10476766666667,19.949194666666667
2019-05-24T10:47:35.304662,60.104768,19.9491915
2019-05-24T10:47:36.297294,60.10476933333333,19.949185833333335
2019-05-24T10:47:37.307060,60.10477233333334,19.949180333333334
2019-05-24T10:47:38.301239,60.10477133333333,19.949175166666667
2019-05-24T10:47:39.304694,60.1047685,19.9491695
2019-05-24T10:47:40.319780,60.10477,19.9491645
2019-05-24T10:47:41.319008,60.10477183333333,19.94916
2019-05-24T10:47:42.343141,60.1047725,19.949158
2019-05-24T10:47:43.299062,60.104774166666665,19.949157666666668
2019-05-24T10:47:44.298081,60.104776333333334,19.949157333333332
2019-05-24T10:47:45.299408,60.104778,19.949156
2019-05-24T10:47:46.323168,60.1047805,19.949154
2019-05-24T10:47:47.305987,60.10478366666667,19.94915183333333
2019-05-24T10:47:48.313259,60.10478616666666,19.949151666666666
2019-05-24T10:47:49.304947,60.104788666666664,19.949150666666668
2019-05-24T10:47:50.307473,60.10479083333333,19.9491455
2019-05-24T10:47:51.298030,60.10479133333333,19.949139666666667
2019-05-24T10:47:52.310731,60.10479016666667,19.949135833333333
2019-05-24T10:47:53.304249,60.10479,19.949132
2019-05-24T10:47:54.293138,60.10479,19.94912666666667
2019-05-24T10:47:55.309964,60.10478916666667,19.949124166666667
2019-05-24T10:47:56.316408,60.1047875,19.9491225
2019-05-24T10:47:57.311958,60.10478633333334,19.949121333333334
2019-05-24T10:47:58.316772,60.104788166666665,19.9491185
2019-05-24T10:47:59.306872,60.104789333333336,19.9491165
2019-05-24T10:48:00.315391,60.1047905,19.949116166666666
2019-05-24T10:48:01.310653,60.1047925,19.949113666666666
2019-05-24T10:48:02.315263,60.10479383333333,19.949109666666665
2019-05-24T10:48:03.302481,60.10479383333333,19.949105666666668
2019-05-24T10:48:04.308586,60.104794,19.949100666666666
2019-05-24T10:48:05.305647,60.10479433333333,19.949097666666667
2019-05-24T10:48:06.293725,60.10479566666667,19.949095833333335
2019-05-24T10:48:07.293578,60.10479866666667,19.949093833333333
2019-05-24T10:48:08.296401,60.10480033333333,19.949093
2019-05-24T10:48:09.279157,60.104803833333335,19.949091
2019-05-24T10:48:10.278874,60.104805166666665,19.949087166666665
2019-05-24T10:48:11.286325,60.10480533333333,19.94908016666667
2019-05-24T10:48:12.292647,60.104804666666666,19.949075833333332
2019-05-24T10:48:13.306465,60.104804333333334,19.949074
2019-05-24T10:48:14.300529,60.104804333333334,19.949074
2019-05-24T10:48:15.323979,60.104804333333334,19.949073833333333
2019-05-24T10:48:16.292760,60.10480483333333,19.94907
2019-05-24T10:48:17.301551,60.104806333333336,19.949067833333334
2019-05-24T10:48:18.310379,60.104808,19.949065166666667
2019-05-24T10:48:19.289183,60.104809833333334,19.9490635
2019-05-24T10:48:20.276329,60.10481016666667,19.949060833333334
2019-05-24T10:48:21.298234,60.1048115,19.949053833333334
2019-05-24T10:48:22.284083,60.104812,19.949047833333335
2019-05-24T10:48:23.297257,60.1048115,19.94904633333333
2019-05-24T10:48:24.297903,60.1048115,19.9490435
2019-05-24T10:48:25.299293,60.104810666666665,19.949040333333333
2019-05-24T10:48:26.302605,60.104810666666665,19.949038166666668
2019-05-24T10:48:27.285358,60.104811833333336,19.949035666666667
2019-05-24T10:48:28.296668,60.104815,19.949032333333335
2019-05-24T10:48:29.298110,60.104816666666665,19.949026
2019-05-24T10:48:30.303131,60.104816166666666,19.94901966666667
2019-05-24T10:48:31.304837,60.104816,19.949013
2019-05-24T10:48:32.316041,60.1048145,19.949007833333333
2019-05-24T10:48:33.289904,60.1048135,19.9490015
2019-05-24T10:48:34.295468,60.1048145,19.9489955
2019-05-24T10:48:35.295553,60.10481333333333,19.948992333333333
2019-05-24T10:48:36.303111,60.104812833333334,19.948988333333332
2019-05-24T10:48:37.314364,60.104813166666666,19.9489845
2019-05-24T10:48:38.299266,60.1048155,19.948982666666666
2019-05-24T10:48:39.304826,60.104817833333335,19.948980333333335
2019-05-24T10:48:40.309762,60.10481866666667,19.948977166666666
2019-05-24T10:48:41.299746,60.10481683333333,19.948972833333332
2019-05-24T10:48:42.307836,60.1048145,19.948966833333333
2019-05-24T10:48:43.308781,60.104814833333336,19.948961833333332
2019-05-24T10:48:44.306485,60.10481333333333,19.948957666666665
2019-05-24T10:48:45.297808,60.104811166666664,19.948951833333332
2019-05-24T10:48:46.306926,60.10480916666667,19.9489465
2019-05-24T10:48:47.299424,60.1048065,19.948943
2019-05-24T10:48:48.306825,60.10480533333333,19.948940166666667
2019-05-24T10:48:49.296263,60.1048055,19.948937166666667
2019-05-24T10:48:50.299746,60.10480666666667,19.948934666666666
2019-05-24T10:48:51.307893,60.10480883333334,19.948931
2019-05-24T10:48:52.301546,60.1048105,19.948927833333332
2019-05-24T10:48:53.301670,60.10481166666667,19.948924166666668
2019-05-24T10:48:54.305878,60.1048125,19.94892
2019-05-24T10:48:55.296489,60.104812,19.948913333333333
2019-05-24T10:48:56.310356,60.10481016666667,19.948905833333335
2019-05-24T10:48:57.318319,60.10480783333333,19.9488995
2019-05-24T10:48:58.324300,60.104805166666665,19.9488965
2019-05-24T10:48:59.286042,60.1048045,19.948892833333332
2019-05-24T10:49:00.310037,60.10480416666667,19.948889
2019-05-24T10:49:01.303320,60.104806833333335,19.948885833333332
2019-05-24T10:49:02.308826,60.10481083333333,19.948884166666666
2019-05-24T10:49:03.311097,60.104813666666665,19.9488825
2019-05-24T10:49:04.302935,60.1048165,19.948879
2019-05-24T10:49:05.317627,60.104816166666666,19.948875166666667
2019-05-24T10:49:06.308167,60.10481633333333,19.948869666666667
2019-05-24T10:49:07.316066,60.1048185,19.948866333333335
2019-05-24T10:49:08.303668,60.10482016666667,19.948864166666667
2019-05-24T10:49:09.292492,60.1048215,19.948861666666666
2019-05-24T10:49:10.281516,60.104823333333336,19.948860333333332
2019-05-24T10:49:11.312145,60.10482616666667,19.948858333333334
2019-05-24T10:49:12.295435,60.10482783333333,19.948857833333335
2019-05-24T10:49:13.283878,60.104827666666665,19.948854166666667
2019-05-24T10:49:14.319365,60.10482983333333,19.948850333333333
2019-05-24T10:49:15.303262,60.10483083333333,19.948848
2019-05-24T10:49:16.305302,60.10483266666667,19.9488455
2019-05-24T10:49:17.304251,60.10483516666667,19.9488445
2019-05-24T10:49:18.306159,60.10483716666667,19.948842666666668
2019-05-24T10:49:19.295880,60.10483983333334,19.948837833333332
2019-05-24T10:49:20.290798,60.1048405,19.948831
2019-05-24T10:49:21.296762,60.1048395,19.948825666666668
2019-05-24T10:49:22.322180,60.104838,19.948822166666666
2019-05-24T10:49:23.310135,60.10483683333333,19.948816666666666`;
  mapMode = Modes.EDIT;
  mission: any;

  snackbar = {
    message: "",
    enabled: false,
    color: "success"
  };

  get initialized(): boolean {
    return this.$store.state.initialized;
  }

  get comPorts(): PortInfo[] {
    return this.$store.state.comPorts;
  }

  get replayInterval(): any {
    return this.$store.state.replayInterval;
  }

  get mapObject(): any {
    return this.$store.state.mapObject;
  }

  openWaypointReplay() {
    this.dialog = false;
    this.mapMode = Modes.REPLAY;
    this.parseWaypoints();
    this.$refs.leaflet.reset();
  }

  closeWaypointReplay() {
    this.dialog = false;
    this.mapMode = Modes.EDIT;
    clearInterval(this.replayInterval);
  }

  parseWaypoints() {
    parse(this.waypointText, {
      complete: (result: any) => {
        const replayWaypoints: Array<ReplayWaypoint> = [];

        const boatPosition = {
          lat: result.data[0][1],
          lng: result.data[0][2]
        };

        this.$store.commit("setBoatPosition", boatPosition);

        result.data.forEach(elem => {
          replayWaypoints.push(
            new ReplayWaypoint({
              timestamp: elem[0],
              lat: elem[1],
              lon: elem[2]
            })
          );
        });
        this.$store.commit("setReplayWaypoints", replayWaypoints);
      }
    });
  }

  mounted() {
    Serialport.list().then((comPorts: PortInfo[]) => {
      this.$store.commit("setComPorts", comPorts);
    });
  }

  sendHeartbeat() {
    this.sendMavlinkMessage(new Heartbeat(255, 0));
  }

  uploadWaypoints(waypoints: any) {
    this.mission = waypoints.geometry.coordinates;
    const missionCount = new MissionCount(255, 0);
    missionCount.count = waypoints.geometry.coordinates.length;
    this.sendMavlinkMessage(missionCount);
  }

  sendMavlinkMessage(message: MAVLinkMessage) {
    const messages: MAVLinkMessage[] = Array<MAVLinkMessage>();
    messages.push(message);
    this.sendMavlinkMessages(messages);
  }

  sendMavlinkMessages(messages: MAVLinkMessage[]) {
    this.serialPort.write(this.mavLink.pack(messages));
  }

  handleSelectCloseClick() {
    this.closeSerialPort();
    this.connectionOpen = false;
  }

  logBuffer(buffer: Buffer) {
    let s = "";
    for (let byte of buffer) {
      s += "0x" + byte.toString(16).toLowerCase() + ", ";
    }
    s = s.substring(0, s.length - 2);
    console.log(s);
  }

  handleComPortChange(comPort: string) {
    if (!comPort) {
      return;
    }
    if (this.mavLink === undefined) {
      this.mavLink = new MAVLinkModule(messageRegistry, 255, false);
      this.mavLink.upgradeLink();
    }

    this.closeSerialPort();

    this.serialPort = new Serialport(comPort, {
      baudRate: 57600
    });

    window.setInterval(() => {
      this.sendHeartbeat();
    }, 1000);

    this.serialPort.on("open", (_: any) => {
      this.connectionOpen = true;
      this.success(`Connection with port ${comPort} opened`);
    });

    this.serialPort.on("error", (e: Error) => {
      this.connectionOpen = false;
      this.error(`Error communicating with port ${comPort}: ${e}`);
    });

    this.serialPort.on("data", (data: Buffer) => {
      // this.logBuffer(data);
      this.mavLink.parse(data);
    });

    this.mavLink.on("error", (error: Error) => {
      // event listener for node-mavlink ALL error message
      // eslint-disable-next-line
      console.error(error);
    });

    this.mavLink.on("message", (message: MAVLinkMessage) => {
      // event listener for all messages
      // eslint-disable-next-line
      console.log(message);
    });

    this.mavLink.on("RADIO_STATUS", (message: RadioStatus) => {
      this.$store.commit(
        "setRssiPercent",
        this.mapRange(message.rssi, 0, 255, 0, 100)
      );

      this.$store.commit(
        "setRemoteRssiPercent",
        this.mapRange(message.remrssi, 0, 255, 0, 100)
      );
    });

    this.mavLink.on("BOAT_STATUS", (message: BoatStatus) => {
      this.$store.commit("setBoatPosition", {
        lat: message.lat / 10000000,
        lng: message.lon / 10000000
      });
      this.$store.commit("setHeading", message.heading);
      this.$store.commit("setPitch", message.pitch);
      this.$store.commit("setRoll", message.roll);
      this.$store.commit("setSpeed", message.speed);
      this.$store.commit("setInitialized");
    });

    this.mavLink.on("MISSION_REQUEST_INT", (message: MissionRequestInt) => {
      const missionItemInt = new MissionItemInt(255, 0);
      // Use count, seq seems buggy
      const item = this.mission[message.count]
      missionItemInt.count = message.count;
      missionItemInt.lat = item[0] * 10000000;
      missionItemInt.lon = item[1] * 10000000;
      this.sendMavlinkMessage(missionItemInt);
    });
  }

  mapRange = (
    value: number,
    in_min: number,
    in_max: number,
    out_min: number,
    out_max: number
  ) => ((value - in_min) * (out_max - out_min)) / (in_max - in_min) + out_min;

  success(message: string) {
    this.snackbar["color"] = "success";
    this.notify(message);
  }

  error(message: string) {
    this.snackbar["color"] = "error";
    this.notify(message);
  }

  notify(message: string) {
    this.snackbar["enabled"] = false;
    this.snackbar["message"] = message;
    this.snackbar["enabled"] = true;
  }

  closeSerialPort() {
    if (this.serialPort !== undefined && this.serialPort.isOpen) {
      this.serialPort.close();
    }
  }

  beforeDestroy() {
    this.closeSerialPort();
  }
}
</script>

<style scoped lang="scss">
.container {
  width: 100%;
  height: 100%;
}

.grid-container {
  width: 100vw;
  height: 100vh;
  padding: 8px;
  display: grid;
  grid-template-columns: 1fr 5fr;
  grid-template-rows: 1fr 10fr;
  grid-template-areas:
    ". select"
    "indicators map";
}

.map {
  grid-area: map;
  width: 100%;
  height: 100%;
  z-index: 1;
}

.select {
  grid-area: select;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.indicators {
  grid-area: indicators;
  width: 100%;
  height: 100%;
}

.select-comPorts {
  width: 200px;
  max-width: 200px;
}

.indicators {
  display: flex;
  flex-direction: column;
}
</style>